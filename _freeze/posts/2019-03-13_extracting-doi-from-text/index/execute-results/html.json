{
  "hash": "96e5a3265ca6d59fbfab29a4b93fd8fb",
  "result": {
    "markdown": "---\ntitle: \"One weird regex matches 97% of DOI...\"\ndescription: \"This one weird regex matches 97% of DOI...\"\ndate: '2019-03-13'\ncategories:\n  - reproducible research\ntags:\n  - regular expressions\n  - stringr\ncode-fold: false\nimage: /posts/softblock-demo/three-designs.jpg\n---\n\nAt least once a month I'm tasked with something that involves working with DOI, but I've never bothered to write a function for extracting these from texts. Time to end that by putting together a tidyversesque `add_doi()` function! \n\n... wait, why?\n\nThe [R for Data Science](https://r4ds.had.co.nz/functions.html) book has lots of excellent advice, including this snippet about reducing duplicated code by writing functions: \n\n![](when-to-write-a-function.png){width=550px alt=\"\"}\n\nSo, what are DOI? DOI (Digital Object Identifiers) are the gold standard for citations. They're guaranteed to point directly to the resource you care about. But how can we reliably extracting DOI from, for example, the following references?\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\")\nexample_references <- tibble(\n  text_citation = c('Gueorgi Kossinets and Duncan J. Watts, \"Origins of Homophily in an Evolving Social Network,\" American Journal of Sociology 115 (2009):414, accessed December 5, 2014, doi:10.1086/599247',\n                        'Morey, C. C., Cong, Y., Zheng, Y., Price, M., & Morey, R. D. (2015). The color-sharing bonus: Roles of perceptual organization and attentive processes in visual working memory. Archives of Scientific Psychology, 3, 18–29. https://doi.org/10.1037/arc0000014',\n                        'Barros, B., Read, T. & Verdejo, M. F. (2008) Virtual collaborative experimentation:\nan approach combining remote and local labs. IEEE Transactions on Education. 51 (2),\n242–250. Available from: doi:10.1109/TE.2007.908071'))\n```\n:::\n\nCrossRef have a great blogpost about how to [match DOIs using regular expressions](https://www.crossref.org/blog/dois-and-matching-regular-expressions/) where they recommend the following regex, which matches 97% of the 74.9 million DOI they tested. The majority of the ~500,000 not matched by this regex are from the *bad old days* of the early noughties, and outside of our interest.\n\n::: {.cell}\n\n```{.r .cell-code}\ndoi_regex <- \"10.\\\\d{4,9}/[-._;()/:a-z0-9A-Z]+\"\n```\n:::\n\nUsing `str_extract()` from the tidyverse package `stringr` allows us to extract the DOIs from our reference:\n\n::: {.cell}\n\n```{.r .cell-code}\nexample_references %>%\n  mutate(doi = str_extract(text_citation, doi_regex))\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  text_citation                                                            doi  \n  <chr>                                                                    <chr>\n1 \"Gueorgi Kossinets and Duncan J. Watts, \\\"Origins of Homophily in an Ev… 10.1…\n2 \"Morey, C. C., Cong, Y., Zheng, Y., Price, M., & Morey, R. D. (2015). T… 10.1…\n3 \"Barros, B., Read, T. & Verdejo, M. F. (2008) Virtual collaborative exp… 10.1…\n```\n:::\n:::\n\nThis can all be rolled together into a function; `add_doi()`. If you're unfamiliar with `!!`, `enquo` and `:=` that's because I'm using `tidyeval`, [find out more about tidyeval here](https://tidyeval.tidyverse.org/modifying-inputs.html). \n\n::: {.cell}\n\n```{.r .cell-code}\nadd_doi <- function(.data, citation_column, name = \"doi\") {\n  citation_column <- enquo(citation_column)\n\n  if (name != \"n\" && name %in% colnames(.data)) {\n    rlang::abort(glue::glue(\"Column `{name}` already exists in the data\"))\n  }\n  \n  .data %>%\n    mutate(!!name := str_extract(!!citation_column, \"10.\\\\d{4,9}/[-._;()/:a-z0-9A-Z]+\"))\n}\n```\n:::\n\nBecause the function is written with `tidyeval` I can use *naked column names* just as a I would with `dplyr::add_count()`:\n\n::: {.cell}\n\n```{.r .cell-code}\nexample_references %>%\n  add_doi(text_citation)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 2\n  text_citation                                                            doi  \n  <chr>                                                                    <chr>\n1 \"Gueorgi Kossinets and Duncan J. Watts, \\\"Origins of Homophily in an Ev… 10.1…\n2 \"Morey, C. C., Cong, Y., Zheng, Y., Price, M., & Morey, R. D. (2015). T… 10.1…\n3 \"Barros, B., Read, T. & Verdejo, M. F. (2008) Virtual collaborative exp… 10.1…\n```\n:::\n:::\n",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}