{
  "hash": "6e073323c431f49a407ecff7a47e3ff7",
  "result": {
    "markdown": "---\ntitle: Christmas Drinks ggplot2 Advent Calendar 2018\ndate: '2018-11-28'\ntidy: 'styler'\nslug: christmas-drinks-ggplot2-advent-calendar-2018\ncategories:\n  - dataviz\ntags:\n  - R\n  - fun\nimage: \"/posts/2018-11-28-christmas-drinks-ggplot2-advent-calendar-2018/2018-11-28_gg-christmass-advent-doors.png\"\ndescription: \"There are just about 24 Christmassy hot drinks available in the big UK cafes. I've made an advent calendae of them in ggplot2, read this post to find out how to do the same.\"\n---\n\n\n\n<br>\nThis Christmas it suddently hit me. There are probably enough festive coffees at Starbucks etc that you could use them to populate a very tasty advent calendar.\n\nIn the interests of helping everyone explore the range of Christmassy drinks on offer, I'll be updating my deposit [24 days of Christmass drinks](https://doi.org/10.6084/m9.figshare.7376228) on Figshare every year from now on. This blogpost takes you through how you can create the advent calendar below using `ggplot2`, I'm planning on creating an extension to make this easier in future [^1].\n\n<!-- <img src='/img/blog-images/2018_advent-calendar/gg_christmass_advent_doors.png' onmouseover=\"this.src='/img/blog-images/2018_advent-calendar/gg_logoed_and_cardboarded_treats.png';\" onmouseout=\"this.src='/img/blog-images/2018_advent-calendar/gg_christmass_advent_doors.png';\" /> -->\n\n<img src='gg_animated_door_openings_small.gif' width='600px'/>\n\n## Christmassy drinks of 2018\n\nBefore we can collate our advent of Christmassy drinks, we need to make some decisions:\n\n- What counts as a Christmassy drink?\n  - Any drink that I can buy all the way through 1st December through to 24th December (so no Pumpkin Spice lattes, sadly).\n\n- Which cafes should be included?\n  - It's my first year doing this. I'm going to choose places that are easy for me to get to!\n\n- Do hot chocolates count?\n  - I really wish they didn't. But I could only find 15 festive coffee-based drinks within easy reach of me.\n\nAfter searching through a few menus, here are my selections for the Christmassy drinks of 2018:\n\n::: {.cell paged.print='false'}\n::: {.cell-output-display}\n```{=html}\n<div id=\"htmlwidget-1b2f14ccd79dd66e396a\" style=\"width:100%;height:100%;\" class=\"widgetframe html-widget\"></div>\n<script type=\"application/json\" data-for=\"htmlwidget-1b2f14ccd79dd66e396a\">{\"x\":{\"url\":\"index_files/figure-html//widgets/widget_internal-show-drinks.html\",\"options\":{\"xdomain\":\"*\",\"allowfullscreen\":false,\"lazyload\":false}},\"evals\":[],\"jsHooks\":[]}</script>\n```\n:::\n:::\n\n## Make your own `ggplot2` advent\n\nIf you want to follow along, please follow these steps first:\n\n1. Create a new RStudio project\n\n2. Create a data directory by running `dir.create(\"data\")`\n\n3. Create a new script `christmassy-drinks-advent.R`, at the top of the script load all the packages we'll need:\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"tidyverse\") # data manipulation\nlibrary(\"grid\") # rasterise images for ggplot2\nlibrary(\"ggpubr\") # set background image for ggplot2 panel\nlibrary(\"magick\") # manipulate images and export a .gif\nlibrary(\"here\") # see https://github.com/jennybc/here_here#readme\n```\n:::\n\n4. Download version 3 of the Figshare deposit [DOI:10.6084/m9.figshare.7376228.v3](https://doi.org/10.6084/m9.figshare.7376228.v3) by adding this code to your script:\n\n::: {.cell}\n\n```{.r .cell-code}\ndir.create(\"data\")\ndownload.file(\"https://ndownloader.figshare.com/articles/7376228/versions/3\",\n              \"data/christmassy-drinks-2018.zip\")\nunzip(\"data/christmassy-drinks-2018.zip\",\n      exdir = \"data\")\nunlink(\"data/christmassy-drinks-2018.zip\")\n```\n:::\n\n5. Can we tidy up things a bit? There are images in the data folder, which isn't very good practice.\n\n::: {.cell}\n\n```{.r .cell-code}\ndir.create(\"images\")\nretailer_logos <- list.files(\"data\", \"*.png|.jpg\", full.names = TRUE)\nfile.copy(retailer_logos, \"images\")\nfile.remove(retailer_logos)\n```\n:::\n\n6. If you follow along exactly with this blogpost, you'll have 200+ lines of code in one script file! Make your life easier by splitting your script in sections as follows ([read more here](https://support.rstudio.com/hc/en-us/articles/200484568-Code-Folding-and-Sections)). Please note there's lots of duplication when following along, it doesn't really take 200+ lines of code to make this!\n\n::: {.cell}\n\n```{.r .cell-code}\n# ---- download data ----\ndownload.file(\"...\") \n# ---- advent doors ----\nggplot(\"...\")\n# ---- advent treats ---- \nggplot(\"...\")\n```\n:::\n\n## ggplot2 advent calendar doors\n\nIn my opinion, there are only really two true advent calendar layouts:\n\n::: {.cell}\n::: {.cell-output-display}\n![](index_files/figure-html/blog-landscape-or-portrait-1.png){width=480}\n:::\n:::\n\nWe can easily compute the centers of all the doors in these advent calendar layouts with `tibble()` and `seq()`:\n\n::: {.cell}\n\n```{.r .cell-code}\nportrait_door_centers <- tibble(\n  x = rep(seq(1, 10, 3), 6),\n  y = rep(seq(1, 16, 3), times = 1, each = 4))\n\nlandscape_door_centers <- tibble(\n  y = rep(seq(1, 10, 3), 6),\n  x = rep(seq(1, 16, 3), times = 1, each = 4))\n```\n:::\n\nThis blogpost will be slightly shorter if we continue with a landscape advent calendar, so let's do that. \n\nWhich `geom_*()` is most suitable for our advent calendar? Well, `geom_tile()` requires only the centre of our doors. The theme `theme_void()` throws away the unnecessary axes labels etc, leaving us with our idealised advent calendar:\n\n::: {.cell}\n\n```{.r .cell-code}\ngg_advent_landscape <- landscape_door_centers %>%\n  ggplot(aes(x, y)) +\n  geom_tile(color = \"black\",\n            size = 0.6,\n            linetype = \"dotted\",\n            alpha=0) +\n  theme_void() +\n  coord_fixed()\ngg_advent_landscape\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/blog-advent-template-1.png){width=480}\n:::\n:::\n\nHow about the door labels? Let's augment the data with door numbers via `mutate()` and then add `geom_label()` to display the door number:\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1)\nlandscape_door_centers <- landscape_door_centers %>%\n  mutate(door_number = sample(1:24))\ngg_advent_landscape <- landscape_door_centers %>%\n  ggplot(aes(x, y)) +\n  geom_tile(color = \"black\",\n            size = 0.6,\n            linetype = \"dotted\",\n            alpha = 0) +\n  geom_label(aes(label = door_number)) +\n  theme_void() +\n  coord_fixed()\ngg_advent_landscape\n```\n\n::: {.cell-output-display}\n![](index_files/figure-html/blog-randomise-door-numbers-1.png){width=480}\n:::\n:::\n\n## ggplot2 advent calendar treats\n\nNow we've created the doors we need to create the Christmassy drink treats! Let's import the drinks data and re-order them via the `door_number` column:\n\n::: {.cell paged.print='false'}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nset.seed(1)\nchristmassy_drinks_2018 <- read_csv(here(\"posts\", \"2018-11-28-christmas-drinks-ggplot2-advent-calendar-2018\", \"24-days-of-christmassy-drinks.csv\")) %>%\n  filter(year == 2018) %>%\n  slice(landscape_door_centers$door_number) %>%\n  mutate(door_number = 1:24)\n\nlandscape_door_treats <- christmassy_drinks_2018 %>%\n  left_join(landscape_door_centers)\n```\n:::\n\nThe festive drinks have very long names (e.g. \"Salted caramel brownie hot chocolate\"), so let's insert line breaks every 10 characters to prettify our labels:\n\n::: {.cell}\n\n```{.r .cell-code}\nlandscape_door_treats <- landscape_door_treats %>%\n  mutate(drink.name = gsub(\"(.{10,}?)\\\\s\", \"\\\\1\\n\", drink.name))\n\ngg_landscape_door_treats <- landscape_door_treats %>%\n  ggplot(aes(x, y)) +\n  geom_tile(color = \"black\",\n            size = 0.6,\n            linetype = \"dotted\",\n            alpha = 0) +\n  geom_label(aes(label = drink.name),\n             nudge_y = 0.5, # give room for logo\n             size = 4) +\n  theme_void() +\n  coord_fixed()\n```\n:::\n\n<img src='gg_landscape_door_treat_labels.png' style='width:600px'/>\n\nIt would look great if we could add the retailers' logos to the squares. Let's first import these images from the `data` folder:\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nstarbucks_logo <- image_read(here(\"images\", \"starbucks_logo_2018.png\")) %>%\n  rasterGrob(interpolate = T)\n\ncosta_logo <- image_read(here(\"images\", \"costa_logo_2018.png\")) %>%\n  rasterGrob(interpolate = T)\n\ncafe_nero_logo <- image_read(here(\"images\", \"cafe-nero_logo_2018.jpg\")) %>%\n  rasterGrob(interpolate = T)\n\ngreggs_logo <- image_read(here(\"images\", \"greggs_logo_2018.png\")) %>%\n  rasterGrob(interpolate = T)\n\npret_logo <- image_read(here(\"images\", \"pret_logo_2018.jpg\")) %>%\n  rasterGrob(interpolate = T)\n\nmc_cafe_logo <- image_read(here(\"images\", \"mc-cafÃ©_logo_2018.png\")) %>%\n  rasterGrob(interpolate = T)\n```\n:::\n\nInserting images into `ggplot2` charts is most easily achieved using `annotation_custom`. After a lot of jiggery pokery, these are fairly good options for nudging the logo into an appropriate position in the door:\n\n::: {.cell}\n\n```{.r .cell-code}\ndoor_center <- list(x = 1, y = 1)\n\nnudge_logo_ymin <- -1.25\nnudge_logo_ymax <- -0.25\nnudge_logo_xmin <- -0.5\nnudge_logo_xmax <- 0.5\n\ngg_one_logo <- gg_landscape_door_treats +\n  annotation_custom(starbucks_logo, \n                    ymin = door_center$y + nudge_logo_ymax, \n                    ymax = door_center$y + nudge_logo_ymin, \n                    xmin = door_center$x + nudge_logo_xmin, \n                    xmax = door_center$x + nudge_logo_xmax)\n```\n:::\n\n<img src='gg_one_logo.png' style='width:600px'/>\n\nBecause `annotation_custom` only allows us to add one image at a time we need to iteratively add logos for each and every door. I'm a `purrr` advocate for this kind of task, but if you don't like this functional approach to things you could use a `for` loop instead.\n\n`pwalk` allows us to iterate a function over every row of `landscape_door_treats`, which in this case adds a `annotation_custom` layer to `gg_logoed_treats`. We use the `<<-` [^2] assignment operator so that the global version of `gg_logoed_treatsis` is updated. `pwalk` is the same as `pmap` but doesn't generate output; side-effects are the only repurcussions of `pwalk`.\n\n::: {.cell}\n\n```{.r .cell-code}\ngg_logoed_treats <- gg_landscape_door_treats\n\nlandscape_door_treats %>%\n  pwalk(function(x, y, retailer, ...){\n    \n    logo <- switch (retailer,\n      \"Starbucks\" = starbucks_logo,\n      \"Costa\" = costa_logo,\n      \"CafÃ© Nero\" = cafe_nero_logo,\n      \"Greggs\" = greggs_logo,\n      \"McCafÃ©\" = mc_cafe_logo,\n      \"Pret\" = pret_logo\n    )\n    gg_logoed_treats <<- gg_logoed_treats +\n      annotation_custom(logo, ymin = y - 1.25, ymax = y - 0.25, xmin = x - 0.5, xmax = x + 0.5)\n    \n  })\n```\n:::\n\n<img src='gg_logoed_treats.png' style='width:600px'/>\n\n## Background images\n\nWe should really add background images to the two parts of our advent calendar; a Christmassy image for the doors and a cardboard background for the insides of the doors.\n\nIf we want a background image applied to the `panel()` component of a `ggplot2` chart we need the `ggpubr` package. The `background_image()` must be called immediately after `ggplot(aes(x, y))` so as to avoid our geoms being hidden behind the background. I found [*beautiful* license-free image from pixelbay](https://pixabay.com/en/santa-christmas-coffee-mugs-3016939/) which I think looks great for our advent calendar. Let's add this file to the images directory and then create our now more festive advent calendar doors:\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ndownload.file(\"https://cdn.pixabay.com/photo/2017/12/13/14/48/santa-3016939_640.jpg\",\n              here(\"posts\", \"2018-11-28-christmas-drinks-ggplot2-advent-calendar-2018\", \"santa-3016939_640.jpg\"))\n\nchristmassy_background <- image_read(here(\"posts\", \"2018-11-28-christmas-drinks-ggplot2-advent-calendar-2018\", \"santa-3016939_640.jpg\"))\n\ngg_advent_landscape <- landscape_door_centers %>%\n  ggplot(aes(x, y)) +\n  background_image(christmassy_background) +\n  geom_tile(color = \"black\",\n            size = 0.6,\n            linetype = \"dotted\",\n            alpha = 0) +\n  geom_label(aes(label = door_number)) +\n  theme_void() +\n  coord_fixed()\ngg_advent_landscape\n```\n:::\n\n<img src='gg_christmass_advent_doors.png' width='600px'/>\n\nI think it's a lot of fun to add a cardboard effect to the treats, so I found this [license-free image from flickr](https://www.flickr.com/photos/27668445@N03/3191148261) which I really enjoy. Let's add it to our images folder and then add it to our advent calendar treats chart:\n\n::: {.cell}\n\n:::\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndownload.file(\"https://farm4.staticflickr.com/3134/3191148261_e3c1f3887b_o_d.jpg\",\n              here(\"images\", \"cardboard-effect.jpg\"))\n\ncardboard_background <- image_read(here(\"images\", \"cardboard-effect.jpg\"))\n\ngg_landscape_door_treats <- landscape_door_treats %>%\n  ggplot(aes(x, y)) +\n  background_image(cardboard_background) +\n  geom_tile(color = \"black\",\n            size = 0.6,\n            linetype = \"dotted\",\n            alpha = 0) +\n  geom_label(aes(label = drink.name),\n             nudge_y = 0.5, # give room for logo\n             size = 4) +\n  theme_void() +\n  coord_fixed()\ngg_landscape_door_treats\n```\n:::\n\n::: {.cell}\n\n:::\n\n<img src='gg_logoed_and_cardboarded_treats.png' width='600px'/>\n\n## Iteratively opening the advent calendar\n\nThe two images we've created so far are only really that useful if we're going to print them out and stick together. And even then, it's a waste of ink printing out a cardboard effect! \n\nLet's create a function for opening the advent doors:\n\n::: {.cell}\n\n```{.r .cell-code}\nopen_advent_doors <- function(gg_advent,\n                              advent_treats,\n                              open_doors) {\n  gg_local <- gg_advent\n\n  advent_treats %>%\n    filter(door_number %in% open_doors) %>%\n    pwalk(function(x, y, retailer, drink.name, ...) {\n      logo <- switch(retailer,\n        \"Starbucks\" = starbucks_logo,\n        \"Costa\" = costa_logo,\n        \"CafÃ© Nero\" = cafe_nero_logo,\n        \"Greggs\" = greggs_logo,\n        \"McCafÃ©\" = mc_cafe_logo,\n        \"Pret\" = pret_logo\n      )\n      gg_local <<- gg_local +\n        annotation_custom(\n          cardboard_background %>%\n            image_crop(\"-200x400\") %>%\n            rasterGrob(interpolate = T),\n          ymin = y - 1.5,\n          ymax = y + 1.5,\n          xmin = x - 2,\n          xmax = x + 2\n        ) +\n        annotation_custom(\n          logo,\n          ymin = y - 1.25,\n          ymax = y - 0.25,\n          xmin = x - 0.5,\n          xmax = x + 0.5\n        ) +\n        geom_label(\n          data = tibble(x, y, drink.name),\n          aes(\n            label = drink.name,\n            x = x,\n            y = y\n          ),\n          nudge_y = 0.5,\n          # give room for logo\n          size = 5\n        )\n    })\n\n  gg_local\n}\n```\n:::\n\nHere's how our calendar looks after opening 10 doors:\n\n::: {.cell}\n\n```{.r .cell-code}\nopen_advent_doors(gg_advent_landscape,\n                    landscape_door_treats,\n                    1:10)\n```\n:::\n\n<img src='gg_opened_10_doors.png' width='600px'/>\n\nUnfortunately, I don't know how to use the **incredible** [gganimate package](https://github.com/thomasp85/gganimate) to animate between door openings. Until I learn how, I'm going to create a .gif by exporting each step of the advent being opened and stitch them together with the `magick` package.\n\n::: {.cell}\n\n```{.r .cell-code}\ntibble(remaining_days = 1:24) %>%\n  rowwise() %>%\n  mutate(doors = list(1:remaining_days)) %>%\n  pwalk(function(doors, ...) {\n    opened_door <- open_advent_doors(\n      gg_advent_landscape,\n      landscape_door_treats,\n      doors\n    )\n\n    img_path <- here(\n        \"data\",\n        paste0(\n          \"gg_iterative_opened_door_\",\n          formatC(\n            length(doors),\n            width = 2,\n            format = \"d\",\n            flag = \"0\"\n          ),\n          \".png\"\n        )\n      )\n    \n    ggsave(\n      img_path,\n      opened_door\n    )\n    \n    image_read(img_path) %>%\n      image_trim() %>%\n      image_resize(\"1400x\") %>%\n      image_write(img_path)\n    \n  })\n\ndoor_open_images <- list.files(\"images\", \"gg_iterative_opened_door\", full.names = TRUE)\n\n\ndoor_open_images %>%\n  tibble(img = .) %>%\n  map(function(img){image_read(img)}) %>%\n  image_join() %>%\n  image_animate(fps = 0.5) %>%\n  image_write(here(\n        \"images\", \"gg_animated_door_openings.gif\"))\n```\n:::\n\n\n::: {.cell}\n\n:::\n\n::: {.cell}\n\n:::\n\n<img src='gg_animated_door_openings_small.gif' width='600px'/>\n\n[^1]: Please get in touch (martin@visibledata.co.uk) if you fancy working on this together, it's very new territory for me.\n\n[^2]: See Hadley Wickham's [StackOverflow answer for more details](https://stackoverflow.com/a/2630222/1659890)\n\n\n\n\n\n\n\n\n\n",
    "supporting": [
      "index_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {
      "include-in-header": [
        "<script src=\"../../site_libs/htmlwidgets-1.5.4/htmlwidgets.js\"></script>\n<script src=\"../../site_libs/pymjs-1.3.2/pym.v1.js\"></script>\n<script src=\"../../site_libs/widgetframe-binding-0.3.1/widgetframe.js\"></script>\n"
      ]
    },
    "engineDependencies": {},
    "preserve": {},
    "postProcess": null
  }
}